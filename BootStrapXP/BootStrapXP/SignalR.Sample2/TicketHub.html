<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Ticket Hub</title>
</head>
<body>
    <h1>
        Ticket Hub</h1>
    <div id="TicketSummary">
        <div data-bind="text:Available, css:{ ImportantMessage: StockIsLow }" class="TicketCount">
        </div>
        <div class="Hidden ImportantMessage" data-bind="css: { Hidden: !StockIsLow() }">
            Event is almost sold out!
         </div>
        <button data-bind="click: BuyTicket, enable: CanBuyTicket">
            Buy a Ticket</button>
    </div>
    <script src="/Scripts/jquery-1.8.0.js"></script>
    <script src="/Scripts/json2.min.js"></script>
    <script src="/Scripts/jquery.signalR-0.5.3.min.js"></script>
    <script src="/Scripts/knockout-2.1.0.js"></script>
    <script src='<%=ResolveClientUrl("../signalr/hubs" %>'></script>
    <script type="text/javascript">
        var ticketDataViewModel = {
            Available: ko.observable(),
            BuyTicket: function () { ticketsHubProxy.buyTicket(); }
        };

        ticketDataViewModel.StockIsLow = ko.dependentObservable(function () {
            return this.Available() < 5 && this.Available() > 0;
        }, ticketDataViewModel);

        ticketDataViewModel.CanBuyTicket = ko.dependentObservable(function () {
            return this.Available() > 0;
        }, ticketDataViewModel);

        ko.applyBindings(ticketDataViewModel, $("#TicketSummary")[0]);

        var ticketsHubProxy;
        $(function () {
            ticketsHubProxy = $.connection.ticketHub;
            ticketsHubProxy.updateTicketCount = function (data) { ticketDataViewModel.Available(data); };
            $.connection.hub.start(function () { ticketsHubProxy.getTicketCount(); });
        });
    </script>
</body>
</html>
